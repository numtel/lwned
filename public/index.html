<html>
<head>
<meta charset="UTF-8">
<title>Lwned</title>
<script src="deps/web3.min.js"></script>
<script src="deps/coinbase.min.js"></script>
<script src="deps/web3modal.min.js"></script>
<script src="wallet.js"></script>
</head>
<body style="max-width:760px; margin:20px auto; padding: 20px;">
<p><a href="https://newgeocities.com/webmaster/blog/lwned.html">Get Lwned!</a></p>
<div>
<script>
function decodeAscii(input) {
  let out = '';
  for(let i = 0; i<input.length; i+=2) {
    out += String.fromCharCode(parseInt(input.slice(i, i+2), 16));
  }
  return out;
}
const parent = document.currentScript.parentNode;
async function loadPage() {
  const config = await configPromise;
  if(window.location.hash.match(/^#0x[a-fA-F0-9]{40}$/)) {
    pageAddress = window.location.hash.slice(1);
  } else {
    pageAddress = config.contracts.LwnedFrontendIndex.address;
  }
  const web3 = await web3ReadOnly();
  // TODO If no render function, render as a profile
  const page = decodeAscii((await web3.eth.call({
    to: pageAddress,
    data: web3.eth.abi.encodeFunctionSignature('render()'),
  })).slice(130));
  parent.innerHTML = page;

  // Scripts are not executed when inserted using innerHTML
  // https://stackoverflow.com/a/47614491
  Array.from(parent.querySelectorAll('script')).forEach(oldScript => {
    const newScript = document.createElement('script');
    Array.from(oldScript.attributes)
      .forEach(attr => newScript.setAttribute(attr.name, attr.value));
    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
    oldScript.parentNode.replaceChild(newScript, oldScript);
  });

}
window.onhashchange = loadPage;
loadPage();
</script>
</div>
