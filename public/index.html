<html>
<head>
<meta charset="UTF-8">
<title>Lwned</title>
<script src="deps/web3.min.js"></script>
<script src="deps/coinbase.min.js"></script>
<script src="deps/web3modal.min.js"></script>
<script src="wallet.js"></script>
<link rel="stylesheet" href="style.css">
</head>
<body>
<h1><a href="https://newgeocities.com/webmaster/blog/lwned.html"><img src="logo.png" alt="Get Lwned!"></a></h1>
<div id="main">
<script>
const parent = document.currentScript.parentNode;
async function loadPage() {
  parent.classList.toggle('loading', true);
  const config = await configPromise;
  if(window.location.hash.match(/^#0x[a-fA-F0-9]{40}/)) {
    pageAddress = window.location.hash.slice(1,43);
  } else {
    pageAddress = config.contracts.LwnedFrontendIndex.address;
  }
  const hashArgs = window.location.hash.split(',').slice(1);

  const web3 = await web3ReadOnly();
  try {
    const page = web3.eth.abi.decodeParameter('string', await web3.eth.call({
      to: pageAddress,
      data: web3.eth.abi.encodeFunctionCall({
        name: 'render',
        type: 'function',
        inputs: hashArgs.map(arg => ({
          // Only supports 3 types atm
          type: String(arg).match(/^0x[a-fA-F0-9]{40}$/) ? 'address' :
            String(arg).match(/^0x[a-fA-F0-9]{64}%/) ? 'bytes32' : 'uint256',
          name: 'something'
        }))
      }, hashArgs)
      }));
    parent.innerHTML = page;

    // Scripts are not executed when inserted using innerHTML
    // https://stackoverflow.com/a/47614491
    Array.from(parent.querySelectorAll('script')).forEach(oldScript => {
      const newScript = document.createElement('script');
      Array.from(oldScript.attributes)
        .forEach(attr => newScript.setAttribute(attr.name, attr.value));
      newScript.appendChild(document.createTextNode(oldScript.innerHTML));
      oldScript.parentNode.replaceChild(newScript, oldScript);
    });
  } catch(error) {
    alert(error.message || error);
  }
  parent.classList.toggle('loading', false);

}
window.onhashchange = loadPage;
loadPage();
</script>
</div>
